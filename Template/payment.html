<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Payment</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body { background-color: #f3f3f3; }

        .payment-card {
            background: #fff;
            border-radius: 12px;
            padding: 30px;
        }

        .section-title {
            font-size: 13px;
            font-weight: 700;
            letter-spacing: 1px;
            margin-bottom: 20px;
        }

        .inputbox {
            position: relative;
            margin-bottom: 25px;
        }

        .inputbox input {
            width: 100%;
            border: none;
            border-bottom: 1px solid #ccc;
            outline: none;
            padding: 8px 0;
            font-size: 15px;
        }

        .inputbox span {
            position: absolute;
            left: 0;
            top: -8px;
            font-size: 12px;
            color: #777;
        }

        .pay-btn {
            background: #5a4df5;
            color: #fff;
            padding: 10px 25px;
            border-radius: 8px;
            border: none;
        }

        .pay-btn:hover { background: #4b3fe0; }

        #card-section { display: none; }
    </style>
    <script src="https://js.stripe.com/v3/"></script>

</head>

<body>

<div class="container mt-5" style="max-width: 800px;">
<form method="post" action="/payment">

<div class="payment-card">

    <div class="section-title">BILLING ADDRESS</div>

    <div class="row">
        <div class="col-md-6">
            <div class="inputbox">
                <input type="text" name="street" required>
                <span>Street Address</span>
            </div>
        </div>
        <div class="col-md-6">
            <div class="inputbox">
                <input type="text" name="city" required>
                <span>City</span>
            </div>
        </div>
        <input type="hidden" name="csrf_token" value="{{ request.cookies.csrf_token }}">
    </div>

    <div class="row">
        <div class="col-md-6">
            <div class="inputbox">
                <input type="text" name="state" required>
                <span>State / Province</span>
            </div>
        </div>
        <div class="col-md-6">
            <div class="inputbox">
                <input type="text" name="zip" pattern="\d{6}" required>
                <span>Zip / Pincode (6 digits)</span>
            </div>
        </div>
    </div>

    <div class="section-title mt-4">PAYMENT METHOD</div>

    <div class="mb-3">
        <input type="radio" name="method" value="COD" checked onclick="toggleCard(false)">
        <label class="ms-2">Cash on Delivery</label>
    </div>

    <div class="mb-3">
        <input type="radio" name="method" value="CARD" onclick="toggleCard(true)">
        <label class="ms-2">Card</label>
    </div>

   <!-- <div id="card-section">
    <div class="section-title mt-4">CARD DETAILS</div>
    <div id="card-element" class="form-control p-3"></div>
    <div id="card-errors" class="text-danger mt-2"></div>
</div>

<input type="hidden" name="payment_intent_id" id="payment_intent_id"> -->

<div id="card-section">
    <div class="section-title mt-4">PAY USING UPI / CARD</div>
    <div id="payment-element"></div>
</div>

<input type="hidden" name="payment_intent_id" id="payment_intent_id">



    <div class="mt-4">
        <button type="submit" class="pay-btn">Pay â‚¹{{ total_amount }}</button>
    </div>

</div>
</form>
</div>
<script>
function toggleCard(show) {
    const section = document.getElementById("card-section");
    section.style.display = show ? "block" : "none";
}

const stripe = Stripe("{{ stripe_pk }}");

let elements;
let paymentElement;

function mountStripe() {
    if (paymentElement) return;

    elements = stripe.elements({ clientSecret: "{{ client_secret }}" });
    paymentElement = elements.create("payment");
    paymentElement.mount("#payment-element");
}

document.querySelectorAll('input[name="method"]').forEach(radio => {
    radio.addEventListener("change", (e) => {
        if (e.target.value === "CARD") {
            toggleCard(true);
            mountStripe();
        } else {
            toggleCard(false);
        }
    });
});

const form = document.querySelector("form");

form.addEventListener("submit", async (e) => {
    const method = document.querySelector('input[name="method"]:checked').value;

    if (method !== "CARD") return;

    e.preventDefault();

    const { error, paymentIntent } = await stripe.confirmPayment({
        elements,
        confirmParams: {
            return_url: window.location.origin + "/payment"
        }
    });

    if (error) {
        alert(error.message);
        return;
    }

    document.getElementById("payment_intent_id").value = paymentIntent.id;
    form.submit();
});
</script>


</body>
</html>
