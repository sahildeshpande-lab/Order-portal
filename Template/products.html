<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Products Portal</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;500;600&display=swap" rel="stylesheet">
    <link href="{{ url_for('static', path='/style.css') }}" rel="stylesheet">
</head>

<body>

    <header class="app-header">
        <h2>Product Page</h2>

        {% if user %}
        <a href="/logout" class="logout-btn">Logout</a>
        {% else %}
        <a href="/login" class="logout-btn">Login</a>
        {% endif %}
    </header>

    {% if flash %}
    <div class="flash-container">
        <div class="flash-message {{ flash.category }}">
            <span>{{ flash.message }}</span>
            <button class="flash-close" onclick="this.parentElement.remove()">√ó</button>
        </div>
    </div>
    {% endif %}



    {% if products %}
    <section id="productSection" class="products-container" style="display:block;">
        <div class="products-grid">

            {% for product in products %}
            <div class="product-col">

                <div class="card">
                    <img src="/{{ product.image }}" class="card-img-top" alt="product">

                    <div class="card-body">
                        <h6>{{ product.title }}</h6>
                        <p>{{ product.description }}</p>

                        <div class="price-row">
                            <span class="old-price">‚Çπ{{ product.price }}</span>
                            <span class="new-price">
                                ‚Çπ{{ product.price - ((product.price * product.discount) / 100) }}
                            </span>
                            <span class="badge">{{ product.discount }}% OFF</span>
                        </div>

                        <!-- ‚≠ê Review Summary -->
                        <div class="review-summary">
                            {% if review_map.get(product.p_id) %}
                            ‚≠ê {{ review_map[product.p_id].avg }}
                            ({{ review_map[product.p_id].count }} reviews)
                            {% else %}
                            No reviews yet
                            {% endif %}
                        </div>

                        {% if user %}
                        <button class="review-toggle-btn" data-product-id="{{ product.p_id }}">
                            ‚úç Write Review
                        </button>
                        <div class="reviewContainer" id="review-{{ product.p_id }}" style="display:none;">

                            <form method="post" action="/add-review" class="review-form">
                                <input type="hidden" name="csrf_token" value="{{ request.cookies.get('csrf_token') }}">
                                <input type="hidden" name="product_id" value="{{ product.p_id }}">

                                <select name="rating" required>
                                    <option value="">Rate</option>
                                    <option value="1">1 ‚≠ê</option>
                                    <option value="2">2 ‚≠ê</option>
                                    <option value="3">3 ‚≠ê</option>
                                    <option value="4">4 ‚≠ê</option>
                                    <option value="5">5 ‚≠ê</option>
                                </select>

                                <textarea name="comment" placeholder="Write review..." rows="2"></textarea>

                                <button type="submit">Submit</button>
                            </form>

                        </div>
                        {% endif %}

                    </div>

                    <div class="card-footer">
                        <button class="order-btn" data-product-id="{{ product.p_id }}">
                            üõí Order Now
                        </button>
                        <div class="inputContainer"></div>
                    </div>
                </div>

            </div>
            {% endfor %}

        </div>
    </section>
    {% endif %}

    <div class="actions-row">

        <a class="fancy" href="/addproduct">
            <span class="top-key"></span>
            <span class="text">Add product</span>
            <span class="bottom-key-1"></span>
            <span class="bottom-key-2"></span>
        </a>
        <a class="fancy" href="/updatediscount">
            <span class="top-key"></span>
            <span class="text">Update discount</span>
            <span class="bottom-key-1"></span>
            <span class="bottom-key-2"></span>
        </a>
        {% if user %}
        <a class="fancy" href="/products/get-orders/{{ user.id }}">
            <span class="top-key"></span>
            <span class="text">Go to Dashboard</span>
            <span class="bottom-key-1"></span>
            <span class="bottom-key-2"></span>
        </a>
        {% else %}
        <a class="fancy" href="/login">
            <span class="text">Go to Dashboard</span>
        </a>
        {% endif %}
    </div>

    <script>
        setTimeout(() => {
            const alert = document.querySelector('.alert');
            if (alert) alert.remove();
        }, 4000);

        document.querySelectorAll(".review-toggle-btn").forEach(btn => {
            btn.addEventListener("click", function () {

                const productId = this.dataset.productId;
                const container = document.getElementById("review-" + productId);

                if (container.style.display === "none") {
                    container.style.display = "block";
                    this.textContent = "‚úñ Cancel Review";
                    this.classList.add("active");
                } else {
                    container.style.display = "none";
                    this.textContent = "‚úç Write Review";
                    this.classList.remove("active");
                }
            });
        });

        document.querySelectorAll(".order-btn").forEach(btn => {
            btn.addEventListener("click", function () {

                const container = this.closest(".card")
                    .querySelector(".inputContainer");

                if (container.innerHTML.trim() !== "") {
                    container.innerHTML = "";
                    this.textContent = "üõí Order Now";
                    this.classList.remove("active");
                    return;
                }

                const productId = this.dataset.productId;


                container.innerHTML = `
            <form method="POST" action="/order" class="order-form">
                <input type="hidden" name="product_id" value="${productId}">
                <input type="number" name="quantity" placeholder="Quantity" required>
                <button type="submit">Confirm Order</button>
            </form>
        `;
                this.textContent = "‚úñ Cancel";
                this.classList.add("active");
            });
        });
    </script>

</body>

</html>